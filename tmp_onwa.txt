  async function onSendWhatsApp(){
    const phoneRaw = state.client.whatsapp;
    if(!phoneRaw){ alert('Preencha o WhatsApp do cliente.'); return; }
    const phoneDigits = String(phoneRaw).replace(/\D+/g,'');
    const waPhone = normalizeWhatsAppNumberBR(phoneDigits);
    if(!waPhone){ alert('WhatsApp inválido.'); return; }
    try{
      const blob = await buildPdf(state);
      const base64 = await new Promise((resolve, reject)=>{
        const reader = new FileReader();
        reader.onload = () => { const res = String(reader.result || ''); resolve(res.split(',').pop() || ''); };
        reader.onerror = (e)=> reject(e);
        reader.readAsDataURL(blob);
      });
      const fileName = `orcamento-TEPintura-${state.meta.number}.pdf`;
      const upload = await fetch('/api/whatsapp/upload',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ fileName, pdfBase64: base64 })
      });
      const data = await upload.json();
      if(!upload.ok || !data?.url){
        console.error('Upload failed', data);
        const baseMsg = `Or	amento TE Pintura N	 ${state.meta.number}\n${state.client.name ? 'Cliente: ' + state.client.name + '\n' : ''}PDF enviado separadamente.`;
        const waUrlFallback = `https://api.whatsapp.com/send?phone=${encodeURIComponent(waPhone)}&text=${encodeURIComponent(baseMsg)}`;
        window.open(waUrlFallback, '_blank');
        return;
      }
      const msg = `Orçamento TE Pintura Nº ${state.meta.number}\n${state.client.name ? 'Cliente: ' + state.client.name + '\n' : ''}PDF: ${data.url}`;
      const waUrl = `https://api.whatsapp.com/send?phone=${encodeURIComponent(waPhone)}&text=${encodeURIComponent(msg)}`;
      window.open(waUrl, '_blank');
    }catch(e){
      console.error(e);
      alert('Erro ao gerar/compartilhar PDF.');
    }
  }
